<%- include('../../partials/admin_layout_start', { pageTitle: 'Donation Management' , path: '/admin/donations' }) %>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="card p-6 flex items-center gap-4 border-l-4 border-l-blue-500">
            <div class="p-4 rounded-full bg-blue-50 text-blue-600">
                <i data-lucide="layers" class="w-6 h-6"></i>
            </div>
            <div>
                <p class="text-sm text-gray-500 font-medium">Total Donations</p>
                <h3 class="text-2xl font-bold text-gray-800">
                    <%= stats.totalDonations %>
                </h3>
            </div>
        </div>
        <div class="card p-6 flex items-center gap-4 border-l-4 border-l-green-500">
            <div class="p-4 rounded-full bg-green-50 text-green-600">
                <i data-lucide="wallet" class="w-6 h-6"></i>
            </div>
            <div>
                <p class="text-sm text-gray-500 font-medium">Funds Collected</p>
                <h3 class="text-2xl font-bold text-gray-800">Rp <%= new
                        Intl.NumberFormat('id-ID').format(stats.totalAmountCollected) %>
                </h3>
            </div>
        </div>
        <div class="card p-6 flex items-center gap-4 border-l-4 border-l-yellow-500">
            <div class="p-4 rounded-full bg-yellow-50 text-yellow-600">
                <i data-lucide="clock" class="w-6 h-6"></i>
            </div>
            <div>
                <p class="text-sm text-gray-500 font-medium">Pending Approval</p>
                <h3 class="text-2xl font-bold text-gray-800">
                    <%= stats.pendingDonations %>
                </h3>
            </div>
        </div>
    </div>

    <div class="card p-6 mb-8">
        <form class="flex flex-col md:flex-row gap-4 items-end">
            <div class="w-full md:w-1/3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Date</label>
                <input type="date" name="date" value="<%= query.date %>" class="input-field">
            </div>
            <div class="w-full md:w-1/3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Min. Amount</label>
                <input type="number" name="minAmount" value="<%= query.minAmount %>" placeholder="e.g 100000"
                    class="input-field">
            </div>
            <div class="w-full md:w-1/3 flex gap-2">
                <button type="submit" class="btn btn-primary flex-1 flex items-center justify-center gap-2">
                    <i data-lucide="filter" class="w-4 h-4"></i> Filter
                </button>
                <a href="/admin/donations" class="btn btn-secondary flex items-center justify-center">Reset</a>
            </div>
        </form>
    </div>

    <div class="card overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-gray-600">
                <thead class="bg-gray-50 text-xs uppercase font-semibold text-gray-700">
                    <tr>
                        <th class="px-6 py-4">ID</th>
                        <th class="px-6 py-4">Date</th>
                        <th class="px-6 py-4">Donor</th>
                        <th class="px-6 py-4">Campaign</th>
                        <th class="px-6 py-4">Amount (Total)</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <% donations.forEach(donation=> { %>
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 font-mono text-xs text-gray-400">#<%= donation.id %>
                            </td>
                            <td class="px-6 py-4 text-xs">
                                <%= new Date(donation.createdAt).toLocaleDateString() %>
                                    <div class="text-gray-400">
                                        <%= new Date(donation.createdAt).toLocaleTimeString([], {hour: '2-digit' ,
                                            minute:'2-digit'}) %>
                                    </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="font-medium text-gray-900">
                                    <%= donation.donorName %>
                                </div>
                                <% if(donation.isAnonymous) { %>
                                    <span class="text-xs text-sage-600 bg-sage-50 px-1.5 py-0.5 rounded">Hamba
                                        Allah</span>
                                    <% } %>
                                        <div class="text-xs text-gray-400 mt-0.5"><i data-lucide="phone"
                                                class="w-3 h-3 inline"></i>
                                            <%= donation.whatsapp %>
                                        </div>
                            </td>
                            <td class="px-6 py-4 max-w-xs truncate" title="<%= donation.campaign.title %>">
                                <%= donation.campaign.title %>
                            </td>
                            <td class="px-6 py-4">
                                <div class="font-bold text-gray-900">
                                    Rp <%= new Intl.NumberFormat('id-ID').format(donation.totalAmount) %>
                                </div>
                                <div class="text-xs text-orange-600">Code: <%= donation.uniqueCode %>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <% if (donation.status===1) { %>
                                    <span
                                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Waiting</span>
                                    <% } else if (donation.status===2) { %>
                                        <span
                                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Confirmed</span>
                                        <% if (donation.approver) { %>
                                            <div class="text-[10px] text-gray-400 mt-1">by: <%=
                                                    donation.approver.email.split('@')[0] %>
                                            </div>
                                            <% } %>
                                                <% } else { %>
                                                    <span
                                                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Cancelled</span>
                                                    <% } %>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <% if (donation.status===1) { %>
                                    <div class="flex items-center justify-end gap-2">
                                        <form action="/admin/donations/<%= donation.id %>/approve" method="POST"
                                            onsubmit="return confirm('Confirm receipt of funds?')" class="inline">
                                            <button type="submit"
                                                class="p-2 bg-green-50 text-green-600 hover:bg-green-100 rounded-lg transition-colors border border-green-200"
                                                title="Confirm Payment">
                                                <i data-lucide="check" class="w-4 h-4"></i>
                                            </button>
                                        </form>
                                        <form action="/admin/donations/<%= donation.id %>/reject" method="POST"
                                            onsubmit="return confirm('Reject this donation?')" class="inline">
                                            <button type="submit"
                                                class="p-2 bg-red-50 text-red-600 hover:bg-red-100 rounded-lg transition-colors border border-red-200"
                                                title="Reject">
                                                <i data-lucide="x" class="w-4 h-4"></i>
                                            </button>
                                        </form>
                                    </div>
                                    <% } else { %>
                                        <span class="text-xs text-gray-400">No actions</span>
                                        <% } %>
                            </td>
                        </tr>
                        <% }) %>
                            <% if(donations.length===0) { %>
                                <tr>
                                    <td colspan="7" class="px-6 py-12 text-center text-gray-500">No donations found
                                        matching criteria.</td>
                                </tr>
                                <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <%- include('../../partials/admin_layout_end') %>